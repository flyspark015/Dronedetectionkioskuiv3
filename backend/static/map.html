<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PMTiles Google‑like Offline Map</title>
  <link href="/vendor/maplibre-gl/maplibre-gl.css" rel="stylesheet">
  <script>
    // Robust crypto.randomUUID polyfill before any scripts run.
    (function () {
      var g = typeof globalThis !== 'undefined' ? globalThis : window;
      if (!g.crypto) g.crypto = {};
      if (typeof g.crypto.randomUUID !== 'function') {
        var poly = function () {
          if (g.crypto && typeof g.crypto.getRandomValues === 'function') {
            var buf = new Uint8Array(16);
            g.crypto.getRandomValues(buf);
            buf[6] = (buf[6] & 0x0f) | 0x40;
            buf[8] = (buf[8] & 0x3f) | 0x80;
            var hex = Array.from(buf, function (b) { return b.toString(16).padStart(2, '0'); }).join('');
            return (
              hex.slice(0, 8) + '-' +
              hex.slice(8, 12) + '-' +
              hex.slice(12, 16) + '-' +
              hex.slice(16, 20) + '-' +
              hex.slice(20)
            );
          }
          return 'uuid-' + Date.now().toString(16) + '-' + Math.random().toString(16).slice(2);
        };
        try {
          g.crypto.randomUUID = poly;
        } catch (e) {
          try {
            Object.defineProperty(g.crypto, 'randomUUID', { value: poly, configurable: true });
          } catch (e2) {}
        }
      }
    })();
  </script>
  <style>
    html, body { margin:0; padding:0; width:100%; height:100%; overflow:hidden; background:#000; }
    #map { position:fixed; inset:0; width:100%; height:100%; }
    #log {
      position:absolute; right:10px; top:10px; padding:8px; font:12px monospace; color:#0f0;
      background:rgba(0,0,0,0.55); z-index:9999; max-width:40vw; white-space:pre-wrap;
    }
    #status {
      position:absolute; left:10px; top:10px; padding:8px 10px; font:12px monospace; color:#e2e8f0;
      background:rgba(0,0,0,0.65); z-index:9999; border:1px solid rgba(255,255,255,0.12);
      border-radius:6px; box-shadow:0 4px 12px rgba(0,0,0,0.35);
    }
    #style-panel {
      position:absolute; left:10px; right:10px; bottom:10px; z-index:9998;
      background:rgba(255,255,255,0.92); color:#111; border:1px solid rgba(0,0,0,0.12);
      border-radius:8px; box-shadow:0 10px 24px rgba(0,0,0,0.25);
      padding:8px; font:12px/1.4 monospace; display:flex; flex-direction:column; gap:6px;
      max-height:35vh;
    }
    #style-panel textarea {
      width:100%; height:180px; resize:vertical; font:12px/1.4 monospace; padding:6px;
      border:1px solid rgba(0,0,0,0.2); border-radius:6px; background:#fff;
    }
    #style-panel .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    #style-panel button {
      font:12px monospace; padding:6px 10px; border-radius:6px; border:1px solid rgba(0,0,0,0.2);
      background:#f3f4f6; cursor:pointer;
    }
    #style-panel button:hover { background:#e5e7eb; }
    #style-status { color:#111; }
    #style-panel.collapsed textarea,
    #style-panel.collapsed .row.extra { display:none; }
  </style>
</head>
<body>
<div id="map"></div>
<div id="status">
  <div id="st-pm">Loading PMTiles...</div>
  <div id="st-style">Style pending</div>
  <div id="st-source">Source pending</div>
  <div id="st-idle">Idle pending</div>
</div>
<div id="log">loading…</div>
<div id="style-panel">
  <div class="row">
    <strong>Style JSON Tester</strong>
    <span id="style-status">ready</span>
    <button id="style-toggle" type="button">Hide</button>
  </div>
  <textarea id="style-input" placeholder="Paste MapLibre style JSON here..."></textarea>
  <div class="row extra">
    <button id="style-apply" type="button">Apply Style</button>
    <button id="style-reset" type="button">Reset Default</button>
    <button id="style-save" type="button">Save Local</button>
    <button id="style-load" type="button">Load Saved</button>
    <button id="style-save-server" type="button">Save to Server</button>
    <button id="style-load-server" type="button">Load from Server</button>
    <button id="style-capture" type="button">Capture Current</button>
    <button id="style-download" type="button">Download JSON</button>
  </div>
</div>

<script src="/vendor/maplibre-gl/maplibre-gl.js"></script>
<script src="/vendor/pmtiles/pmtiles.js"></script>

<script>
  const logEl = document.getElementById('log');
  const statusEl = document.getElementById('status');
  const stylePanel = document.getElementById('style-panel');
  const styleInput = document.getElementById('style-input');
  const styleStatus = document.getElementById('style-status');
  const styleToggle = document.getElementById('style-toggle');
  const styleApply = document.getElementById('style-apply');
  const styleReset = document.getElementById('style-reset');
  const styleSave = document.getElementById('style-save');
  const styleLoad = document.getElementById('style-load');
  const styleSaveServer = document.getElementById('style-save-server');
  const styleLoadServer = document.getElementById('style-load-server');
  const styleCapture = document.getElementById('style-capture');
  const styleDownload = document.getElementById('style-download');
  const DEBUG = new URLSearchParams(window.location.search).get('debug') === '1';
  if (!DEBUG) {
    logEl.style.display = 'none';
    statusEl.style.display = 'none';
  }
  const log = (...a) => {
    if (!DEBUG) return;
    console.log(...a);
    logEl.textContent += '\n' + a.join(' ');
  };
  const logError = (...a) => {
    console.error(...a);
    if (DEBUG) logEl.textContent += '\n' + a.join(' ');
  };
  const stPm = document.getElementById('st-pm');
  const stStyle = document.getElementById('st-style');
  const stSource = document.getElementById('st-source');
  const stIdle = document.getElementById('st-idle');

  // PMTiles protocol
  const protocol = new pmtiles.Protocol();
  maplibregl.addProtocol('pmtiles', protocol.tile);

  const PMTILES_URL = window.location.origin + "/pmtiles/india.pmtiles";
  const SOURCE_URL  = "pmtiles://" + PMTILES_URL;
  const OFFLINE_STYLE_URL = "/style-offline.json?v=2";

  const normalizeStyle = (s) => {
    if (!s || typeof s !== 'object') return s;
    if (s.sources && s.sources.pm && s.sources.pm.type === 'vector') {
      s.sources.pm.url = SOURCE_URL;
    } else if (s.sources) {
      // replace any placeholder or maptiler URL if present
      for (const key of Object.keys(s.sources)) {
        const src = s.sources[key];
        if (!src || src.type !== 'vector') continue;
        if (src.url === '__PMTILES__') src.url = SOURCE_URL;
      }
    }
    if (s.glyphs) s.glyphs = "/fonts-local/{fontstack}/{range}.pbf";
    if (s.sprite) delete s.sprite;
    return s;
  };

  const style = {
    version: 8,
    name: "MapTiler 3D (Offline)",
    metadata: {
      "mapbox:autocomposite": false,
      "maputnik:renderer": "mbgljs",
      "openmaptiles:version": "3.x"
    },
    glyphs: "/fonts-local/{fontstack}/{range}.pbf",
    sources: { pm: { type: "vector", url: SOURCE_URL } },
    layers: [
      {
        id: "background",
        type: "background",
        paint: { "background-color": "hsl(47, 26%, 88%)" }
      }
    ]
  };

  const map = new maplibregl.Map({
    container: "map",
    style,
    center: [77.1025, 28.7041],
    zoom: 4,
    maxZoom: 19,
    attributionControl: false
  });

  let defaultStyleJson = null;
  let defaultCaptured = false;
  let externalStyleApplied = false;
  let externalStyleTried = false;
  const SAVED_KEY = 'pmtiles_style_saved_v1';

  styleToggle.addEventListener('click', () => {
    const collapsed = stylePanel.classList.toggle('collapsed');
    styleToggle.textContent = collapsed ? 'Show' : 'Hide';
  });
  styleApply.addEventListener('click', () => {
    let parsed;
    try {
      parsed = JSON.parse(styleInput.value || '{}');
    } catch (e) {
      styleStatus.textContent = `parse error: ${e.message}`;
      return;
    }
    styleStatus.textContent = 'applying…';
    try {
      externalStyleApplied = true;
      externalStyleTried = true;
      map.setStyle(normalizeStyle(parsed));
      styleStatus.textContent = 'style set (loading…)';
    } catch (e) {
      styleStatus.textContent = `apply error: ${e.message || e}`;
    }
  });
  styleReset.addEventListener('click', () => {
    if (!defaultStyleJson) {
      styleStatus.textContent = 'default not captured yet';
      return;
    }
    styleStatus.textContent = 'resetting…';
    try {
      externalStyleApplied = false;
      externalStyleTried = true;
      map.setStyle(defaultStyleJson);
      styleStatus.textContent = 'reset (loading…)';
      styleInput.value = JSON.stringify(defaultStyleJson, null, 2);
    } catch (e) {
      styleStatus.textContent = `reset error: ${e.message || e}`;
    }
  });

  styleSave.addEventListener('click', () => {
    let parsed;
    try {
      parsed = JSON.parse(styleInput.value || '{}');
    } catch (e) {
      styleStatus.textContent = `save parse error: ${e.message}`;
      return;
    }
    const pretty = JSON.stringify(parsed, null, 2);
    localStorage.setItem(SAVED_KEY, pretty);
    styleStatus.textContent = 'saved to browser storage';
  });

  styleLoad.addEventListener('click', () => {
    const saved = localStorage.getItem(SAVED_KEY);
    if (!saved) {
      styleStatus.textContent = 'no saved style found';
      return;
    }
    styleInput.value = saved;
    styleStatus.textContent = 'loaded saved style (not applied)';
  });

  styleSaveServer.addEventListener('click', async () => {
    let parsed;
    try {
      parsed = JSON.parse(styleInput.value || '{}');
    } catch (e) {
      styleStatus.textContent = `save parse error: ${e.message}`;
      return;
    }
    styleStatus.textContent = 'saving to server…';
    try {
      const res = await fetch('/api/v1/style/save', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(parsed)
      });
      if (!res.ok) {
        const t = await res.text();
        styleStatus.textContent = `save error: ${res.status} ${t}`;
        return;
      }
      styleStatus.textContent = 'saved to server';
    } catch (e) {
      styleStatus.textContent = `save error: ${e.message || e}`;
    }
  });

  styleLoadServer.addEventListener('click', async () => {
    styleStatus.textContent = 'loading from server…';
    try {
      const res = await fetch('/api/v1/style/saved', { cache: 'no-store' });
      if (!res.ok) {
        const t = await res.text();
        styleStatus.textContent = `load error: ${res.status} ${t}`;
        return;
      }
      const text = await res.text();
      styleInput.value = text;
      styleStatus.textContent = 'loaded from server (not applied)';
    } catch (e) {
      styleStatus.textContent = `load error: ${e.message || e}`;
    }
  });

  styleCapture.addEventListener('click', () => {
    try {
      const cur = map.getStyle();
      styleInput.value = JSON.stringify(cur, null, 2);
      styleStatus.textContent = 'captured current style';
    } catch (e) {
      styleStatus.textContent = `capture error: ${e.message || e}`;
    }
  });

  styleDownload.addEventListener('click', () => {
    let parsed;
    try {
      parsed = JSON.parse(styleInput.value || '{}');
    } catch (e) {
      styleStatus.textContent = `download parse error: ${e.message}`;
      return;
    }
    const pretty = JSON.stringify(parsed, null, 2);
    const blob = new Blob([pretty], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'style.json';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    styleStatus.textContent = 'downloaded style.json';
  });

  const safeAddLayer = (layer, beforeId) => {
    try {
      map.addLayer(layer, beforeId);
      return true;
    } catch (e) {
      const msg = e && e.message ? e.message : String(e);
      log(`[DISABLED] ${layer.id} reason: ${msg}`);
      return false;
    }
  };

  let idleLogged = false;
  const addedLayers = [];

  map.on('error', (e) => {
    const msg = (e && e.error && e.error.message) ? e.error.message : JSON.stringify(e);
    if (msg && msg.includes('randomUUID')) return; // ignore known noise
    logError(`[MAP_ERROR] ${msg}`);
  });

  map.on('sourcedata', (e) => {
    if (e && e.isSourceLoaded && e.sourceId === 'pm') {
      stSource.textContent = 'Source loaded';
    }
  });

  map.on('styledata', () => {
    stStyle.textContent = 'Style loaded';
    log('[STYLE] styledata');
  });

  map.on('idle', () => {
    if (!idleLogged) {
      log('[EVENT] idle');
      stIdle.textContent = 'Idle';
      idleLogged = true;
    }
    if (!defaultCaptured) {
      try {
        defaultStyleJson = map.getStyle();
        styleInput.value = JSON.stringify(defaultStyleJson, null, 2);
        styleStatus.textContent = 'default captured';
        defaultCaptured = true;
      } catch (e) {
        styleStatus.textContent = `capture error: ${e.message || e}`;
      }
    }
    if (!styleInput.value) {
      const saved = localStorage.getItem(SAVED_KEY);
      if (saved) {
        styleInput.value = saved;
        styleStatus.textContent = 'saved style found (not applied)';
      }
    }
  });

  map.on('load', async () => {
    log('[EVENT] load');
    stPm.textContent = 'PMTiles ready';

    if (!externalStyleTried) {
      externalStyleTried = true;
      try {
        const res = await fetch(OFFLINE_STYLE_URL, { cache: 'no-store' });
        if (res.ok) {
          const ext = await res.json();
          normalizeStyle(ext);
          externalStyleApplied = true;
          map.setStyle(ext);
          stStyle.textContent = 'Offline style loaded';
          styleStatus.textContent = 'offline style applied';
          return;
        }
      } catch (e) {
        log('[STYLE] offline style not loaded:', e && e.message ? e.message : String(e));
      }
    }
    if (externalStyleApplied) return;

    // Fit to India + neighbors
    try {
      const p = new pmtiles.PMTiles(PMTILES_URL);
      const meta = await p.getMetadata();
      const m = (typeof meta === 'string') ? JSON.parse(meta) : meta;
      const b = (m && Array.isArray(m.bounds) && m.bounds.length === 4) ? m.bounds : [58,0,106,40];
      map.fitBounds([[b[0], b[1]],[b[2], b[3]]], { padding:20, duration:0 });

      // Field detection log (from metadata)
      if (DEBUG && m && Array.isArray(m.vector_layers)) {
        m.vector_layers.forEach((vl) => {
          const keys = vl && vl.fields ? Object.keys(vl.fields) : [];
          log(`[STYLE] fields ${vl.id}: ${keys.join(', ')}`);
        });
      }

      const fieldsMap = {};
      if (m && Array.isArray(m.vector_layers)) {
        m.vector_layers.forEach((vl) => {
          fieldsMap[vl.id] = vl.fields ? Object.keys(vl.fields) : [];
        });
      }
      const hasField = (layer, field) => (fieldsMap[layer] || []).includes(field);
      const hasLayer = (layer) => Object.prototype.hasOwnProperty.call(fieldsMap, layer);
      const pickField = (layer, candidates) => {
        for (let i = 0; i < candidates.length; i++) {
          if (hasField(layer, candidates[i])) return candidates[i];
        }
        return null;
      };
      const nameExpr = (layer) => {
        const candidates = ['name', 'name:en', 'name_en', 'pgf:name', 'pgf:name:en', 'name2', 'name3'];
        const present = candidates.filter((c) => hasField(layer, c));
        if (!present.length) return null;
        return ['coalesce', ...present.map((c) => ['get', c]), ''];
      };
      const toNumberExpr = (field) => ['to-number', ['get', field]];
      const makeBoolFilter = (field) => ["any",
        ["==", field, 1],
        ["==", field, "1"],
        ["==", field, true],
        ["==", field, "true"],
        ["==", field, "yes"]
      ];

      
      const src = "pm";
      const poly = ["==", "$type", "Polygon"];
      const line = ["==", "$type", "LineString"];
      const point = ["==", "$type", "Point"];

      const lcKind = hasField('landcover', 'kind') ? 'kind' : null;
      const lcDetail = hasField('landcover', 'kind_detail') ? 'kind_detail' : null;
      const luKind = hasField('landuse', 'kind') ? 'kind' : null;
      const luDetail = hasField('landuse', 'kind_detail') ? 'kind_detail' : null;
      const rdKind = hasField('roads', 'kind') ? 'kind' : null;
      const rdDetail = hasField('roads', 'kind_detail') ? 'kind_detail' : null;
      const bdKind = hasField('boundaries', 'kind') ? 'kind' : null;
      const bdDetail = hasField('boundaries', 'kind_detail') ? 'kind_detail' : null;
      const wtKind = hasField('water', 'kind') ? 'kind' : null;
      const wtDetail = hasField('water', 'kind_detail') ? 'kind_detail' : null;
      const plKind = hasField('places', 'kind') ? 'kind' : null;
      const plDetail = hasField('places', 'kind_detail') ? 'kind_detail' : null;

      const inKinds = (kindField, detailField, values) => {
        const filters = [];
        if (kindField) filters.push(["in", kindField, ...values]);
        if (detailField) filters.push(["in", detailField, ...values]);
        if (!filters.length) return null;
        return filters.length === 1 ? filters[0] : ["any", ...filters];
      };
      const makePolyFilter = (kindField, detailField, values) => {
        const f = ["all", poly];
        const kf = inKinds(kindField, detailField, values);
        if (kf) f.push(kf);
        return f;
      };
      const makeLineFilter = (kindField, detailField, values) => {
        const f = ["all", line];
        const kf = inKinds(kindField, detailField, values);
        if (kf) f.push(kf);
        return f;
      };
      const add = (layer, beforeId) => {
        if (safeAddLayer(layer, beforeId)) addedLayers.push(layer.id);
      };

      // LANDUSE / LANDCOVER (MapTiler 3D palette)
      if (hasLayer('landuse')) {
        add({
          id: "landuse-residential",
          type: "fill",
          source: src,
          "source-layer": "landuse",
          filter: makePolyFilter(luKind, luDetail, ["residential"]),
          layout: {"visibility": "visible"},
          paint: {"fill-color": "hsl(47, 13%, 86%)", "fill-opacity": 0.7}
        });
      }

      if (hasLayer('landcover')) {
        add({
          id: "landcover_grass",
          type: "fill",
          source: src,
          "source-layer": "landcover",
          filter: makePolyFilter(lcKind, lcDetail, ["grass", "grassland", "meadow"]),
          paint: {"fill-color": "hsl(82, 46%, 72%)", "fill-opacity": 0.45}
        });
      }

      if (hasLayer('landuse')) {
        add({
          id: "park",
          type: "fill",
          source: src,
          "source-layer": "landuse",
          filter: makePolyFilter(luKind, luDetail, ["park", "garden", "recreation_ground", "golf_course", "pitch", "cemetery"]),
          paint: {
            "fill-color": "rgba(192, 216, 151, 0.53)",
            "fill-opacity": 1,
            "fill-outline-color": "rgba(159, 183, 118, 0.69)"
          }
        });
      }

      if (hasLayer('landcover')) {
        add({
          id: "landcover_wood",
          type: "fill",
          source: src,
          "source-layer": "landcover",
          filter: makePolyFilter(lcKind, lcDetail, ["wood", "forest", "scrub"]),
          paint: {
            "fill-color": "hsl(82, 46%, 72%)",
            "fill-opacity": ["interpolate", ["linear"], ["zoom"], 8, 0.6, 22, 1]
          }
        });
      }

      if (hasLayer('water')) {
        add({
          id: "water",
          type: "fill",
          source: src,
          "source-layer": "water",
          filter: ["all", poly],
          paint: {"fill-color": "hsl(205, 56%, 73%)"}
        });
      }

      if (hasLayer('landcover')) {
        add({
          id: "landcover-ice-shelf",
          type: "fill",
          source: src,
          "source-layer": "landcover",
          filter: makePolyFilter(lcKind, lcDetail, ["ice_shelf", "ice"]),
          layout: {"visibility": "visible"},
          paint: {"fill-color": "hsl(47, 26%, 88%)", "fill-opacity": 0.8}
        });
        add({
          id: "landcover-glacier",
          type: "fill",
          source: src,
          "source-layer": "landcover",
          filter: makePolyFilter(lcKind, lcDetail, ["glacier", "snow", "ice"]),
          layout: {"visibility": "visible"},
          paint: {
            "fill-color": "hsl(47, 22%, 94%)",
            "fill-opacity": ["interpolate", ["linear"], ["zoom"], 0, 1, 8, 0.5]
          }
        });
      }

      if (hasLayer('landuse')) {
        add({
          id: "landuse",
          type: "fill",
          source: src,
          "source-layer": "landuse",
          filter: makePolyFilter(luKind, luDetail, ["agriculture", "farmland", "farm", "orchard", "meadow"]),
          layout: {"visibility": "visible"},
          paint: {"fill-color": "#eae0d0"}
        });
      }

      if (hasLayer('landcover')) {
        add({
          id: "landuse_overlay_national_park",
          type: "fill",
          source: src,
          "source-layer": "landcover",
          filter: makePolyFilter(lcKind, lcDetail, ["national_park"]),
          paint: {
            "fill-color": "#E1EBB0",
            "fill-opacity": ["interpolate", ["linear"], ["zoom"], 5, 0, 9, 0.75]
          }
        });
      }

      // WATERWAYS
      if (hasLayer('water')) {
        add({
          id: "waterway_tunnel",
          type: "line",
          source: src,
          "source-layer": "water",
          filter: makeLineFilter(wtKind, wtDetail, ["tunnel"]),
          layout: {"visibility": "visible"},
          paint: {
            "line-color": "hsl(205, 56%, 73%)",
            "line-dasharray": [3, 3],
            "line-gap-width": ["interpolate", ["linear"], ["zoom"], 12, 0, 20, 6],
            "line-opacity": 1,
            "line-width": ["interpolate", ["exponential", 1.4], ["zoom"], 8, 1, 20, 2]
          }
        });
        add({
          id: "waterway",
          type: "line",
          source: src,
          "source-layer": "water",
          filter: makeLineFilter(wtKind, wtDetail, ["river", "canal", "stream", "ditch", "drain"]),
          layout: {"visibility": "none"},
          paint: {
            "line-color": "hsl(205, 56%, 73%)",
            "line-opacity": 1,
            "line-width": ["interpolate", ["exponential", 1.4], ["zoom"], 8, 1, 20, 8]
          }
        });
        add({
          id: "waterway_intermittent",
          type: "line",
          source: src,
          "source-layer": "water",
          filter: makeLineFilter(wtKind, wtDetail, ["intermittent", "seasonal"]),
          layout: {"visibility": "visible"},
          paint: {
            "line-color": "hsl(205, 56%, 73%)",
            "line-dasharray": [2, 1],
            "line-opacity": 1,
            "line-width": ["interpolate", ["exponential", 1.4], ["zoom"], 8, 1, 20, 8]
          }
        });
      }

      // RAIL + ROADS (transportation)
      if (hasLayer('roads')) {
        const roadFilter = (detailValues, kindValues) => {
          const f = ["all", line];
          const kf = inKinds(rdKind, rdDetail, kindValues || []);
          const df = inKinds(rdDetail, null, detailValues || []);
          if (kf && df) f.push(["any", kf, df]);
          else if (kf) f.push(kf);
          else if (df) f.push(df);
          return f;
        };

        add({
          id: "tunnel_railway_transit",
          type: "line",
          source: src,
          "source-layer": "roads",
          minzoom: 0,
          filter: ["all", line, makeBoolFilter("is_tunnel"), ["any",
            ["in", rdDetail || "kind_detail", "transit", "subway", "light_rail"],
            ["in", rdKind || "kind", "railway", "rail"]
          ]],
          layout: {"line-cap": "butt", "line-join": "miter"},
          paint: {
            "line-color": "hsl(34, 12%, 66%)",
            "line-dasharray": [3, 3],
            "line-opacity": ["interpolate", ["linear"], ["zoom"], 11, 0, 16, 1]
          }
        });

        add({
          id: "road_path",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: roadFilter(["path", "track"], ["path"]),
          layout: {"line-cap": "square", "line-join": "bevel"},
          paint: {
            "line-color": "hsl(0, 0%, 97%)",
            "line-dasharray": [1, 1],
            "line-width": ["interpolate", ["exponential", 1.55], ["zoom"], 4, 0.25, 20, 10]
          }
        });

        add({
          id: "road_minor",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: roadFilter(["minor", "service", "residential", "living_street"], ["minor_road", "residential"]),
          layout: {"line-cap": "round", "line-join": "round"},
          paint: {
            "line-color": "hsl(0, 0%, 97%)",
            "line-width": ["interpolate", ["exponential", 1.55], ["zoom"], 4, 0.25, 20, 30]
          }
        });

        add({
          id: "tunnel_minor",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: ["all", line, makeBoolFilter("is_tunnel"), roadFilter(["minor", "service"], ["minor_road"])],
          layout: {"line-cap": "butt", "line-join": "miter"},
          paint: {
            "line-color": "#efefef",
            "line-dasharray": [0.36, 0.18],
            "line-width": ["interpolate", ["exponential", 1.55], ["zoom"], 4, 0.25, 20, 30]
          }
        });

        add({
          id: "tunnel_major",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: ["all", line, makeBoolFilter("is_tunnel"), roadFilter(["primary", "secondary", "tertiary", "trunk"], ["major_road"])],
          layout: {"line-cap": "butt", "line-join": "miter"},
          paint: {
            "line-color": "#fff",
            "line-dasharray": [0.28, 0.14],
            "line-width": ["interpolate", ["exponential", 1.4], ["zoom"], 6, 0.5, 20, 30]
          }
        });

        add({
          id: "road_trunk_primary",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: roadFilter(["trunk", "primary"], ["major_road"]),
          layout: {"line-cap": "round", "line-join": "round"},
          paint: {
            "line-color": "#fff",
            "line-width": ["interpolate", ["exponential", 1.4], ["zoom"], 6, 0.5, 20, 30]
          }
        });

        add({
          id: "road_secondary_tertiary",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: roadFilter(["secondary", "tertiary"], ["minor_road"]),
          layout: {"line-cap": "round", "line-join": "round"},
          paint: {
            "line-color": "#fff",
            "line-width": ["interpolate", ["exponential", 1.4], ["zoom"], 6, 0.5, 20, 20]
          }
        });

        add({
          id: "road_major_motorway",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: roadFilter(["motorway"], ["highway"]),
          layout: {"line-cap": "round", "line-join": "round"},
          paint: {
            "line-color": "hsl(0, 0%, 100%)",
            "line-offset": 0,
            "line-width": ["interpolate", ["exponential", 1.4], ["zoom"], 8, 1, 16, 10]
          }
        });

        add({
          id: "railway_transit",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: roadFilter(["transit", "light_rail", "subway", "tram"], ["railway", "rail"]),
          layout: {"visibility": "visible"},
          paint: {
            "line-color": "hsl(34, 12%, 66%)",
            "line-opacity": ["interpolate", ["linear"], ["zoom"], 11, 0, 16, 1]
          }
        });

        add({
          id: "railway",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: roadFilter(["rail", "railway"], ["railway", "rail"]),
          layout: {"visibility": "visible"},
          paint: {
            "line-color": "hsl(34, 12%, 66%)",
            "line-opacity": ["interpolate", ["linear"], ["zoom"], 11, 0, 16, 1]
          }
        });

        add({
          id: "bridge_minor case",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: ["all", line, makeBoolFilter("is_bridge"), roadFilter(["minor", "service"], ["minor_road"])],
          layout: {"line-cap": "butt", "line-join": "miter"},
          paint: {
            "line-color": "#dedede",
            "line-gap-width": ["interpolate", ["exponential", 1.55], ["zoom"], 4, 0.25, 20, 30],
            "line-width": ["interpolate", ["exponential", 1.6], ["zoom"], 12, 0.5, 20, 10]
          }
        });

        add({
          id: "bridge_major case",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: ["all", line, makeBoolFilter("is_bridge"), roadFilter(["primary", "secondary", "tertiary", "trunk"], ["major_road"])],
          layout: {"line-cap": "butt", "line-join": "miter"},
          paint: {
            "line-color": "#dedede",
            "line-gap-width": ["interpolate", ["exponential", 1.55], ["zoom"], 4, 0.25, 20, 30],
            "line-width": ["interpolate", ["exponential", 1.6], ["zoom"], 12, 0.5, 20, 10]
          }
        });

        add({
          id: "bridge_minor",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: ["all", line, makeBoolFilter("is_bridge"), roadFilter(["minor", "service"], ["minor_road"])],
          layout: {"line-cap": "round", "line-join": "round"},
          paint: {
            "line-color": "#efefef",
            "line-width": ["interpolate", ["exponential", 1.55], ["zoom"], 4, 0.25, 20, 30]
          }
        });

        add({
          id: "bridge_major",
          type: "line",
          source: src,
          "source-layer": "roads",
          filter: ["all", line, makeBoolFilter("is_bridge"), roadFilter(["primary", "secondary", "tertiary", "trunk"], ["major_road"])],
          layout: {"line-cap": "round", "line-join": "round"},
          paint: {
            "line-color": "#fff",
            "line-width": ["interpolate", ["exponential", 1.4], ["zoom"], 6, 0.5, 20, 30]
          }
        });
      }

      // BOUNDARIES (country / state / local)
      if (hasLayer('boundaries')) {
        const hasSort = hasField('boundaries', 'sort_rank');
        const countryKinds = ["country", "macroregion", "country_region", "sovereign", "territory"];
        const stateKinds = ["region", "state", "province", "admin1", "adm1", "state_region"];
        const localKinds = ["county", "district", "localadmin", "locality", "subregion", "subdistrict", "admin2", "adm2", "municipality", "city", "ward"];

        const countryFilter = ["all", line];
        const stateFilter = ["all", line];
        const localFilter = ["all", line];

        if (hasSort) {
          const sr = ["to-number", ["get", "sort_rank"]];
          countryFilter.push(["<=", sr, 3]);
          stateFilter.push([">=", sr, 4], ["<=", sr, 6]);
          localFilter.push([">=", sr, 7]);
        } else {
          const ck = inKinds(bdKind, bdDetail, countryKinds);
          if (ck) countryFilter.push(ck);
          const sk = inKinds(bdKind, bdDetail, stateKinds);
          if (sk) stateFilter.push(sk);
          const lk = inKinds(bdKind, bdDetail, localKinds);
          if (lk) localFilter.push(lk);
        }

        const countryHasFilter = countryFilter.length > 2;
        const stateHasFilter = stateFilter.length > 2;
        const localHasFilter = localFilter.length > 2;

        if (countryHasFilter) {
          add({
            id: "admin_country",
            type: "line",
            source: src,
            "source-layer": "boundaries",
            filter: countryFilter,
            layout: {"line-cap": "round", "line-join": "round"},
            paint: {
              "line-color": "#374151",
              "line-width": ["interpolate", ["exponential", 1.25], ["zoom"], 0, 1.8, 6, 1.2, 12, 0.8]
            }
          });
        }

        if (stateHasFilter) {
          add({
            id: "admin_state",
            type: "line",
            source: src,
            "source-layer": "boundaries",
            minzoom: 4,
            filter: stateFilter,
            layout: {"line-cap": "round", "line-join": "round"},
            paint: {
              "line-color": "#9aa0a6",
              "line-width": ["interpolate", ["exponential", 1.2], ["zoom"], 4, 1.1, 10, 0.7, 14, 0.5],
              "line-dasharray": [2, 1]
            }
          });
        }

        if (localHasFilter) {
          add({
            id: "admin_local",
            type: "line",
            source: src,
            "source-layer": "boundaries",
            minzoom: 7,
            filter: localFilter,
            layout: {"line-cap": "round", "line-join": "round"},
            paint: {
              "line-color": "#c2c6cc",
              "line-width": ["interpolate", ["exponential", 1.15], ["zoom"], 7, 0.8, 12, 0.5],
              "line-dasharray": [1, 2]
            }
          });
        }

        if (hasField('boundaries', 'disputed')) {
          add({
            id: "admin_disputed",
            type: "line",
            source: src,
            "source-layer": "boundaries",
            filter: ["all", line, ["==", "disputed", 1]],
            layout: {"line-cap": "round", "line-join": "round"},
            paint: {
              "line-color": "#d0d4d9",
              "line-width": ["interpolate", ["exponential", 1.2], ["zoom"], 3, 1.0, 10, 0.6],
              "line-dasharray": [1, 1.5]
            }
          });
        }

        if (!countryHasFilter && !stateHasFilter && !localHasFilter) {
          add({
            id: "admin_all",
            type: "line",
            source: src,
            "source-layer": "boundaries",
            filter: ["all", line],
            layout: {"line-cap": "round", "line-join": "round"},
            paint: {
              "line-color": "#9aa0a6",
              "line-width": ["interpolate", ["linear"], ["zoom"], 0, 0.8, 10, 0.5],
              "line-opacity": 0.8
            }
          });
        }
      }

      // ROAD LABELS
      const roadTextField = nameExpr('roads');
      const hasRoadNameEn = hasField('roads', 'name:en');
      if (hasLayer('roads') && roadTextField) {
        const roadTextEn = hasRoadNameEn ? ["get", "name:en"] : roadTextField;
        const roadTextLocal = hasField('roads', 'name') ? ["get", "name"] : roadTextField;

        const roadLabelFilter = ["all", line];
        if (hasRoadNameEn) roadLabelFilter.push(["!has", "name:en"]);
        add({
          id: "road_major_label",
          type: "symbol",
          source: src,
          "source-layer": "roads",
          filter: roadLabelFilter,
          layout: {
            "symbol-placement": "line",
            "text-field": roadTextLocal,
            "text-font": ["Klokantech Noto Sans Regular"],
            "text-letter-spacing": 0.1,
            "text-rotation-alignment": "map",
            "text-size": ["interpolate", ["exponential", 1.4], ["zoom"], 10, 8, 20, 14],
            "text-transform": "uppercase"
          },
          paint: {
            "text-color": "#000",
            "text-halo-color": "hsl(0, 0%, 100%)",
            "text-halo-width": 2
          }
        });

        if (hasRoadNameEn) {
          add({
            id: "road_major_label-en",
            type: "symbol",
            source: src,
            "source-layer": "roads",
            filter: ["all", line, ["has", "name:en"]],
            layout: {
              "symbol-placement": "line",
              "text-field": ["concat", roadTextEn, " ", roadTextLocal],
              "text-font": ["Klokantech Noto Sans Regular"],
              "text-letter-spacing": 0.1,
              "text-rotation-alignment": "map",
              "text-size": ["interpolate", ["exponential", 1.4], ["zoom"], 10, 8, 20, 14],
              "text-transform": "uppercase"
            },
            paint: {
              "text-color": "#000",
              "text-halo-color": "hsl(0, 0%, 100%)",
              "text-halo-width": 2
            }
          });
        }
      }

// BUILDINGS 3D
      if (hasLayer('buildings')) {
        const heightField = hasField('buildings', 'height') ? 'height' : null;
        const minHeightField = hasField('buildings', 'min_height') ? 'min_height' : null;
        add({
          id: "building-3d",
          type: "fill-extrusion",
          source: src,
          "source-layer": "buildings",
          filter: ["all", poly],
          minzoom: 15,
          paint: {
            "fill-extrusion-base": minHeightField ? ["to-number", ["get", minHeightField]] : 0,
            "fill-extrusion-color": "hsl(39, 41%, 86%)",
            "fill-extrusion-height": heightField ? ["to-number", ["get", heightField]] : 10,
            "fill-extrusion-opacity": 0.6
          }
        });
      }

      // PLACE LABELS
      const placeTextField = nameExpr('places');
      const hasPlaceNameEn = hasField('places', 'name:en');
      const hasCapital = hasField('places', 'capital');
      if (hasLayer('places') && placeTextField) {
        const placeTextEn = hasPlaceNameEn ? ["get", "name:en"] : placeTextField;
        const placeTextLocal = hasField('places', 'name') ? ["get", "name"] : placeTextField;

        const makePlaceFilter = (kindValues) => {
          const f = ["all", point];
          const kf = inKinds(plKind, plDetail, kindValues);
          if (kf) f.push(kf);
          return f;
        };
        const withNameFilter = (base, wantEn) => {
          const f = base.slice();
          if (hasPlaceNameEn) f.push(wantEn ? ["has", "name:en"] : ["!has", "name:en"]);
          return f;
        };

        const countryBase = makePlaceFilter(["country", "sovereign", "territory", "macroregion", "country_region"]);
        const stateBase = makePlaceFilter(["state", "province", "region", "admin1", "adm1"]);
        const cityBase = makePlaceFilter(["city"]);
        const townBase = makePlaceFilter(["town"]);
        const villageBase = makePlaceFilter(["village", "hamlet", "suburb", "neighbourhood", "neighborhood"]);
        const otherBase = makePlaceFilter(["locality"]);

        const capitalBase = ["all", point];
        if (hasCapital) {
          capitalBase.push(["any",
            ["==", "capital", 2],
            ["==", "capital", "2"],
            ["==", "capital", 1],
            ["==", "capital", "1"]
          ]);
          const notCapitalFilters = [
            ["!=", "capital", 2],
            ["!=", "capital", "2"],
            ["!=", "capital", 1],
            ["!=", "capital", "1"]
          ];
          cityBase.push(...notCapitalFilters);
          townBase.push(...notCapitalFilters);
          villageBase.push(...notCapitalFilters);
          otherBase.push(...notCapitalFilters);
        }

        // Country labels
        add({
          id: "country_label",
          type: "symbol",
          source: src,
          "source-layer": "places",
          minzoom: 2,
          maxzoom: 12,
          filter: withNameFilter(countryBase, false),
          layout: {
            "text-field": placeTextLocal,
            "text-font": ["Klokantech Noto Sans Bold"],
            "text-max-width": 10,
            "text-size": ["interpolate", ["linear"], ["zoom"], 2, 12, 6, 18, 10, 22]
          },
          paint: {
            "text-color": "#202124",
            "text-halo-blur": 0,
            "text-halo-color": "rgba(255,255,255,0.85)",
            "text-halo-width": 2
          }
        });
        if (hasPlaceNameEn) {
          add({
            id: "country_label-en",
            type: "symbol",
            source: src,
            "source-layer": "places",
            minzoom: 2,
            maxzoom: 12,
            filter: withNameFilter(countryBase, true),
            layout: {
              "text-field": ["concat", placeTextEn, "\n", placeTextLocal],
              "text-font": ["Klokantech Noto Sans Bold"],
              "text-max-width": 10,
              "text-size": ["interpolate", ["linear"], ["zoom"], 2, 12, 6, 18, 10, 22]
            },
            paint: {
              "text-color": "#202124",
              "text-halo-blur": 0,
              "text-halo-color": "rgba(255,255,255,0.85)",
              "text-halo-width": 2
            }
          });
        }

        // State labels
        add({
          id: "state_label",
          type: "symbol",
          source: src,
          "source-layer": "places",
          minzoom: 4,
          maxzoom: 12,
          filter: withNameFilter(stateBase, false),
          layout: {
            "text-field": placeTextLocal,
            "text-font": ["Klokantech Noto Sans Regular"],
            "text-max-width": 10,
            "text-size": ["interpolate", ["linear"], ["zoom"], 4, 11, 8, 14]
          },
          paint: {
            "text-color": "#3c4043",
            "text-halo-blur": 0,
            "text-halo-color": "rgba(255,255,255,0.85)",
            "text-halo-width": 2
          }
        });
        if (hasPlaceNameEn) {
          add({
            id: "state_label-en",
            type: "symbol",
            source: src,
            "source-layer": "places",
            minzoom: 4,
            maxzoom: 12,
            filter: withNameFilter(stateBase, true),
            layout: {
              "text-field": ["concat", placeTextEn, "\n", placeTextLocal],
              "text-font": ["Klokantech Noto Sans Regular"],
              "text-max-width": 10,
              "text-size": ["interpolate", ["linear"], ["zoom"], 4, 11, 8, 14]
            },
            paint: {
              "text-color": "#3c4043",
              "text-halo-blur": 0,
              "text-halo-color": "rgba(255,255,255,0.85)",
              "text-halo-width": 2
            }
          });
        }

        // Capital labels (slightly larger)
        if (hasCapital) {
          add({
            id: "capital_label",
            type: "symbol",
            source: src,
            "source-layer": "places",
            minzoom: 4,
            filter: withNameFilter(capitalBase, false),
            layout: {
              "text-field": placeTextLocal,
              "text-font": ["Klokantech Noto Sans Bold"],
              "text-max-width": 10,
              "text-size": ["interpolate", ["linear"], ["zoom"], 4, 12, 9, 16, 12, 18]
            },
            paint: {
              "text-color": "#202124",
              "text-halo-blur": 0,
              "text-halo-color": "rgba(255,255,255,0.85)",
              "text-halo-width": 2
            }
          });
        }

        // City / town / village
        add({
          id: "place_label_city",
          type: "symbol",
          source: src,
          "source-layer": "places",
          minzoom: 6,
          maxzoom: 16,
          filter: withNameFilter(cityBase, false),
          layout: {
            "text-field": placeTextLocal,
            "text-font": ["Klokantech Noto Sans Regular"],
            "text-max-width": 10,
            "text-size": ["interpolate", ["linear"], ["zoom"], 6, 12, 10, 16]
          },
          paint: {
            "text-color": "#202124",
            "text-halo-blur": 0,
            "text-halo-color": "hsla(0, 0%, 100%, 0.75)",
            "text-halo-width": 2
          }
        });
        if (hasPlaceNameEn) {
          add({
            id: "place_label_city-en",
            type: "symbol",
            source: src,
            "source-layer": "places",
            minzoom: 6,
            maxzoom: 16,
            filter: withNameFilter(cityBase, true),
            layout: {
              "text-field": ["concat", placeTextEn, "\n", placeTextLocal],
              "text-font": ["Klokantech Noto Sans Regular"],
              "text-max-width": 10,
              "text-size": ["interpolate", ["linear"], ["zoom"], 6, 12, 10, 16]
            },
            paint: {
              "text-color": "#202124",
              "text-halo-blur": 0,
              "text-halo-color": "hsla(0, 0%, 100%, 0.75)",
              "text-halo-width": 2
            }
          });
        }

        add({
          id: "place_label_town",
          type: "symbol",
          source: src,
          "source-layer": "places",
          minzoom: 8,
          maxzoom: 16,
          filter: withNameFilter(townBase, false),
          layout: {
            "text-field": placeTextLocal,
            "text-font": ["Klokantech Noto Sans Regular"],
            "text-max-width": 8,
            "text-size": ["interpolate", ["linear"], ["zoom"], 8, 11, 12, 14]
          },
          paint: {
            "text-color": "#3c4043",
            "text-halo-blur": 0,
            "text-halo-color": "hsla(0, 0%, 100%, 0.8)",
            "text-halo-width": 1.5
          }
        });
        if (hasPlaceNameEn) {
          add({
            id: "place_label_town-en",
            type: "symbol",
            source: src,
            "source-layer": "places",
            minzoom: 8,
            maxzoom: 16,
            filter: withNameFilter(townBase, true),
            layout: {
              "text-field": ["concat", placeTextEn, "\n", placeTextLocal],
              "text-font": ["Klokantech Noto Sans Regular"],
              "text-max-width": 8,
              "text-size": ["interpolate", ["linear"], ["zoom"], 8, 11, 12, 14]
            },
            paint: {
              "text-color": "#3c4043",
              "text-halo-blur": 0,
              "text-halo-color": "hsla(0, 0%, 100%, 0.8)",
              "text-halo-width": 1.5
            }
          });
        }

        add({
          id: "place_label_village",
          type: "symbol",
          source: src,
          "source-layer": "places",
          minzoom: 11,
          maxzoom: 16,
          filter: withNameFilter(villageBase, false),
          layout: {
            "text-field": placeTextLocal,
            "text-font": ["Klokantech Noto Sans Regular"],
            "text-max-width": 6,
            "text-size": ["interpolate", ["linear"], ["zoom"], 11, 10, 14, 12]
          },
          paint: {
            "text-color": "#5f6368",
            "text-halo-blur": 0,
            "text-halo-color": "hsla(0, 0%, 100%, 0.85)",
            "text-halo-width": 1.2
          }
        });
        if (hasPlaceNameEn) {
          add({
            id: "place_label_village-en",
            type: "symbol",
            source: src,
            "source-layer": "places",
            minzoom: 11,
            maxzoom: 16,
            filter: withNameFilter(villageBase, true),
            layout: {
              "text-field": ["concat", placeTextEn, "\n", placeTextLocal],
              "text-font": ["Klokantech Noto Sans Regular"],
              "text-max-width": 6,
              "text-size": ["interpolate", ["linear"], ["zoom"], 11, 10, 14, 12]
            },
            paint: {
              "text-color": "#5f6368",
              "text-halo-blur": 0,
              "text-halo-color": "hsla(0, 0%, 100%, 0.85)",
              "text-halo-width": 1.2
            }
          });
        }

        add({
          id: "place_label_other",
          type: "symbol",
          source: src,
          "source-layer": "places",
          minzoom: 9,
          maxzoom: 16,
          filter: withNameFilter(otherBase, false),
          layout: {
            "text-anchor": "center",
            "text-field": placeTextLocal,
            "text-font": ["Klokantech Noto Sans Regular"],
            "text-max-width": 6,
            "text-size": ["interpolate", ["linear"], ["zoom"], 9, 10, 12, 13],
            "visibility": "visible"
          },
          paint: {
            "text-color": "hsl(0, 10%, 25%)",
            "text-halo-blur": 0,
            "text-halo-color": "hsl(0, 0%, 100%)",
            "text-halo-width": 2
          }
        });
        if (hasPlaceNameEn) {
          add({
            id: "place_label_other-en",
            type: "symbol",
            source: src,
            "source-layer": "places",
            minzoom: 9,
            maxzoom: 16,
            filter: withNameFilter(otherBase, true),
            layout: {
              "text-anchor": "center",
              "text-field": ["concat", placeTextEn, "\n", placeTextLocal],
              "text-font": ["Klokantech Noto Sans Regular"],
              "text-max-width": 6,
              "text-size": ["interpolate", ["linear"], ["zoom"], 9, 10, 12, 13],
              "visibility": "visible"
            },
            paint: {
              "text-color": "hsl(0, 10%, 25%)",
              "text-halo-blur": 0,
              "text-halo-color": "hsl(0, 0%, 100%)",
              "text-halo-width": 2
            }
          });
        }
      }
stStyle.textContent = 'Style loaded';
      log(`[STYLE] layers count: ${addedLayers.length + 1}`);

    } catch (e) {
      const msg = e && e.message ? e.message : String(e);
      log(`[MAP_ERROR] ${msg}`);
    }
  });
</script>
</body>
</html>
